<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KDDI APAR</title>
  </head>
  <body>
    {% include 'navbar.html' %}
    <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>
    {% block content %}{% endblock %}
    <script src="/static/js/htmx.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
    <script>
        function appendAlert(message, type = 'danger') {
            const alertPlaceholder = document.getElementById('alert-container');
            const wrapper = document.createElement('div');
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');
            alertPlaceholder.append(wrapper);

            // Optional: Auto-dismiss after 5 seconds
            setTimeout(() => {
                wrapper.remove();
            }, 5000);
        }

        // Global HTMX listener for custom server events
        document.body.addEventListener('showAlert', function (evt) {
            appendAlert(evt.detail.message, evt.detail.type);
        });

        // Global HTMX listener to handle standard HTTP errors
        document.body.addEventListener('htmx:beforeSwap', function (evt) {
            if (evt.detail.xhr.status >= 400) {
                evt.detail.shouldSwap = false;
                // Attempt to get the error detail from FastAPI's JSON response
                try {
                    const response = JSON.parse(evt.detail.xhr.response);
                    appendAlert(response.detail || 'An error occurred', 'danger');
                } catch (e) {
                    appendAlert('Server Error: ' + evt.detail.xhr.status, 'danger');
                }
            }
        });
    </script>
  </body>
</html>
